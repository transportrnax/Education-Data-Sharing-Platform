{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Private Data Access</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3>Available Services</h3>
                    <div class="list-group">
                        {% for service in available_services %}
                        <div class="list-group-item">
                            <h5 class="mb-1">{{ service.name }}</h5>
                            <p class="mb-1">{{ service.description }}</p>
                            <p class="mb-1">Fee: ¥{{ service.fee }}</p>
                            <button class="btn btn-primary" onclick="processPayment('{{ service.id }}', '{{ service.fee }}', '{{ service.name }}')">
                                Access Service
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h3>Payment History</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Service</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistory">
                                <!-- Payment history will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Service: <span id="serviceName"></span></p>
                <p>Amount: ¥<span id="paymentAmount">0.00</span></p>
                <form id="paymentForm">
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="transfer">Bank Transfer</option>
                            <option value="paypal">PayPal</option>
                            <option value="wechat">WeChat Pay</option>
                            <option value="alipay">Alipay</option>
                            <option value="credit_card">Credit Card</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmPayment">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentServiceId = null;

function processPayment(serviceId, amount, serviceName) {
    currentServiceId = serviceId;
    document.getElementById('serviceName').textContent = serviceName;
    document.getElementById('paymentAmount').textContent = amount;
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    paymentModal.show();
}

document.getElementById('confirmPayment').addEventListener('click', function() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    fetch('/payment/payments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            service_type: 'private_data_access',
            amount: parseFloat(document.getElementById('paymentAmount').textContent),
            payment_method: paymentMethod,
            description: `Payment for ${document.getElementById('serviceName').textContent}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Payment successful! You now have access to the service.');
            loadPaymentHistory();
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to process payment');
    });
});

function loadPaymentHistory() {
    fetch('/payment/payments')
        .then(response => response.json())
        .then(payments => {
            const historyTable = document.getElementById('paymentHistory');
            historyTable.innerHTML = '';
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(payment.created_at).toLocaleString()}</td>
                    <td>${payment.description}</td>
                    <td>¥${payment.amount}</td>
                    <td><span class="badge bg-${payment.status === 'completed' ? 'success' : 'warning'}">${payment.status}</span></td>
                `;
                historyTable.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load payment history');
        });
}

// Load payment history on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPaymentHistory();
});
</script>
{% endblock %} 